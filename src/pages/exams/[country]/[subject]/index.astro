---
/**
 * Subject Practice Page
 *
 * Dynamic route: /exams/[country]/[subject]
 * Filters questions by country and subject for focused practice.
 */
import Layout from '../../../../layouts/Layout.astro';
import ExamView from '../../../../components/ExamView.svelte';
import { countries } from '../../../../data/countries';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allQuestions = await getCollection('questions');

  // Build paths for each country + subject combination
  const paths: Array<{
    params: { country: string; subject: string };
    props: { countryData: typeof countries[0]; subjectName: string; countryFolder: string };
  }> = [];

  for (const country of countries.filter(c => c.status === 'live')) {
    const countryCode = country.code.toLowerCase();
    const countryFolder = country.folder || countryCode;

    // Get questions for this country (using folder name)
    const countryQuestions = allQuestions.filter(q => {
      const questionPath = q.id.split('/')[0];
      return questionPath === '_shared' || questionPath === countryFolder;
    });

    // Get unique subjects
    const subjects = [...new Set(countryQuestions.map(q => q.data.asignatura))];

    for (const subject of subjects) {
      paths.push({
        params: {
          country: countryCode,
          subject: subject.toLowerCase().replace(/\s+/g, '-'),
        },
        props: {
          countryData: country,
          subjectName: subject,
          countryFolder,
        },
      });
    }
  }

  return paths;
}

const { country, subject } = Astro.params;
const { countryData, subjectName, countryFolder } = Astro.props;

// Get all questions for this country + subject
const allQuestions = await getCollection('questions');

const subjectQuestions = allQuestions.filter(q => {
  const questionPath = q.id.split('/')[0];
  const isCountryMatch = questionPath === '_shared' || questionPath === countryFolder;
  const subjectSlug = q.data.asignatura.toLowerCase().replace(/\s+/g, '-');
  return isCountryMatch && subjectSlug === subject;
});

// Parse markdown content to extract question data
async function parseQuestion(entry: typeof subjectQuestions[0]) {
  const rawContent = entry.body;

  // Parse the markdown structure
  const sections = rawContent.split(/^#\s+/m).filter(Boolean);

  let questionText = '';
  let options: { letter: string; text: string; isCorrect: boolean }[] = [];
  let explanation = '';

  for (const section of sections) {
    const lines = section.trim().split('\n');
    const title = lines[0]?.toLowerCase() || '';
    const content = lines.slice(1).join('\n').trim();

    if (title.includes('pregunta') || title.includes('question') || title.includes('pergunta')) {
      questionText = content;
    } else if (title.includes('opciones') || title.includes('options') || title.includes('opÃ§Ãµes')) {
      const optionMatches = content.matchAll(/- \[([ x])\] ([A-D])\) (.+)/g);
      for (const match of optionMatches) {
        options.push({
          letter: match[2],
          text: match[3],
          isCorrect: match[1] === 'x',
        });
      }
    } else if (title.includes('explicaciÃ³n') || title.includes('explanation') || title.includes('explicaÃ§Ã£o')) {
      explanation = content;
    }
  }

  return {
    id: entry.id,
    content: questionText,
    options,
    explanation,
    subject: entry.data.asignatura,
    topic: entry.data.tema,
  };
}

// Get available grades for filtering
const availableGrades = [...new Set(subjectQuestions.map(q => q.data.grado))].sort((a, b) => a - b);

// Parse all questions (shuffled)
const shuffled = subjectQuestions.sort(() => Math.random() - 0.5);
const questions = await Promise.all(shuffled.map(parseQuestion));
---

<Layout title={`${subjectName} - ${countryData.name}`}>
  <section class="min-h-screen py-24 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <a href={`/exams/${country}`} class="text-text-secondary hover:text-accent-cyan transition-colors mb-4 inline-block">
          â† Volver a {countryData.name}
        </a>
        <div class="flex items-center justify-center gap-4 mt-4">
          <span class="text-4xl">{countryData.flag}</span>
          <div>
            <h1 class="text-3xl font-bold">{subjectName}</h1>
            <p class="text-text-secondary">{countryData.exam}</p>
          </div>
        </div>

        <!-- Stats -->
        <div class="flex justify-center gap-6 mt-6">
          <div class="text-center">
            <div class="text-2xl font-bold text-accent-cyan">{subjectQuestions.length}</div>
            <div class="text-xs text-text-secondary uppercase tracking-widest">Preguntas</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-accent-gold">
              {availableGrades.length > 1
                ? `${Math.min(...availableGrades)}-${Math.max(...availableGrades)}`
                : availableGrades[0] || '-'}
            </div>
            <div class="text-xs text-text-secondary uppercase tracking-widest">Grados</div>
          </div>
        </div>
      </div>

      {questions.length > 0 ? (
        <!-- Exam Component -->
        <ExamView
          client:load
          questions={questions}
          countryName={countryData.name}
          countryFlag={countryData.flag}
          countryCode={country}
        />
      ) : (
        <!-- No Questions -->
        <div class="bg-bg-card rounded-2xl p-8 border border-white/5 text-center">
          <div class="text-6xl mb-4">ğŸ“š</div>
          <h2 class="text-2xl font-bold mb-2">No hay preguntas disponibles</h2>
          <p class="text-text-secondary mb-6">
            Esta asignatura aÃºn no tiene preguntas cargadas para {countryData.name}.
          </p>
          <a href={`/exams/${country}`} class="btn-primary inline-block">
            â† Volver al Portal
          </a>
        </div>
      )}

      <!-- Navigation Links -->
      <div class="mt-12 flex flex-wrap justify-center gap-4">
        <a href={`/exams/${country}/practice`} class="btn-secondary">
          ğŸ¯ PrÃ¡ctica Mixta
        </a>
        <a href={`/exams/${country}`} class="text-text-secondary hover:text-accent-cyan transition-colors px-4 py-2">
          ğŸ“‹ Ver todas las materias
        </a>
      </div>
    </div>
  </section>
</Layout>
