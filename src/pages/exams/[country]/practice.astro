---
import Layout from '../../../layouts/Layout.astro';
import ExamView from '../../../components/ExamView.svelte';
import { countries } from '../../../data/countries';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  return countries
    .filter(c => c.status === 'live')
    .map(country => ({
      params: { country: country.code.toLowerCase() },
      props: { countryData: country },
    }));
}

const { country } = Astro.params;
const { countryData } = Astro.props;

// Get the folder name for questions (may differ from country code)
const countryFolder = countryData.folder || country;

// Get all questions for this country
const allQuestions = await getCollection('questions');

// Filter: _shared + country specific
const countryQuestions = allQuestions.filter(q => {
  const questionPath = q.id.split('/')[0];
  return questionPath === '_shared' || questionPath === countryFolder;
});

// Parse markdown content to extract question data
async function parseQuestion(entry: typeof countryQuestions[0]) {
  const { Content } = await entry.render();
  const rawContent = entry.body;

  // Parse the markdown structure
  const sections = rawContent.split(/^#\s+/m).filter(Boolean);

  let questionText = '';
  let options: { letter: string; text: string; isCorrect: boolean }[] = [];
  let explanation = '';

  for (const section of sections) {
    const lines = section.trim().split('\n');
    const title = lines[0]?.toLowerCase() || '';
    const content = lines.slice(1).join('\n').trim();

    if (title.includes('pregunta') || title.includes('question') || title.includes('pergunta')) {
      questionText = content;
    } else if (title.includes('opciones') || title.includes('options') || title.includes('opções')) {
      const optionMatches = content.matchAll(/- \[([ x])\] ([A-D])\) (.+)/g);
      for (const match of optionMatches) {
        options.push({
          letter: match[2],
          text: match[3],
          isCorrect: match[1] === 'x',
        });
      }
    } else if (title.includes('explicación') || title.includes('explanation') || title.includes('explicação')) {
      explanation = content;
    }
  }

  return {
    id: entry.id,
    content: questionText,
    options,
    explanation,
    subject: entry.data.asignatura,
    topic: entry.data.tema,
  };
}

// Shuffle and take 10 questions
const shuffled = countryQuestions.sort(() => Math.random() - 0.5);
const selected = shuffled.slice(0, 10);
const questions = await Promise.all(selected.map(parseQuestion));
---

<Layout title={`Práctica - ${countryData.name}`}>
  <section class="min-h-screen py-24 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <a href={`/exams/${country}`} class="text-text-secondary hover:text-accent-cyan transition-colors mb-4 inline-block">
          ← Volver a {countryData.name}
        </a>
        <div class="flex items-center justify-center gap-4 mt-4">
          <span class="text-4xl">{countryData.flag}</span>
          <h1 class="text-3xl font-bold">Examen de Práctica</h1>
        </div>
        <p class="text-text-secondary mt-2">{countryData.exam}</p>
      </div>

      <!-- Exam Component -->
      <ExamView
        client:load
        questions={questions}
        countryName={countryData.name}
        countryFlag={countryData.flag}
        countryCode={country}
      />
    </div>
  </section>
</Layout>
