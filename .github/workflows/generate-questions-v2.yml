name: Generate Questions (Protocol v2.0)

on:
  issues:
    types: [opened, labeled]

  workflow_dispatch:
    inputs:
      country:
        description: 'Country code (CO, MX, BR, US, etc.)'
        required: true
        type: string
      category:
        description: 'Category (mathematics, science, history, geography)'
        required: true
        type: string
      num_bundles:
        description: 'Number of question bundles (7 questions each)'
        required: true
        type: number
        default: 5

env:
  PROTOCOL_VERSION: "2.0"

jobs:
  validate_request:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'generate-questions-v2')
    outputs:
      country: ${{ steps.parse.outputs.country }}
      category: ${{ steps.parse.outputs.category }}
      num_bundles: ${{ steps.parse.outputs.num_bundles }}

    steps:
      - name: Parse issue body
        id: parse
        run: |
          # Extract parameters from issue body
          echo "Parsing issue for generation parameters..."
          echo "country=${{ github.event.inputs.country || 'CO' }}" >> $GITHUB_OUTPUT
          echo "category=${{ github.event.inputs.category || 'mathematics' }}" >> $GITHUB_OUTPUT
          echo "num_bundles=${{ github.event.inputs.num_bundles || '5' }}" >> $GITHUB_OUTPUT

  generate_content:
    needs: validate_request
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create generation prompt
        id: prompt
        run: |
          cat << 'EOF' > /tmp/generation_prompt.md
          # ðŸŽ¯ Task: Generate Question Bundles (Protocol v2.0)

          ## Configuration
          - **Country:** ${{ needs.validate_request.outputs.country }}
          - **Category:** ${{ needs.validate_request.outputs.category }}
          - **Bundles to generate:** ${{ needs.validate_request.outputs.num_bundles }}
          - **Protocol Version:** 2.0

          ## CRITICAL: Protocol v2.0 Requirements

          Each bundle file MUST contain exactly **7 questions**:

          | # | Type | Difficulty | Requirements |
          |---|------|------------|--------------|
          | 1 | Original | 3 | Base question adapted with cultural context |
          | 2 | Easy A | 1-2 | Simplified, basic recognition |
          | 3 | Easy B | 1-2 | Simplified, different context |
          | 4 | Medium A | 3 | Practical application with local context |
          | 5 | Medium B | 3 | Analysis or comparison |
          | 6 | Hard A | 4-5 | Multi-step problem |
          | 7 | Hard B | 4-5 | Complex reasoning/synthesis |

          ## Cultural Context Requirements

          ### For ${{ needs.validate_request.outputs.country }}:
          - Use local currency in numerical examples
          - Reference local cities, landmarks, institutions
          - Use culturally appropriate names and scenarios
          - Match educational terminology to national curriculum

          ## File Naming Convention

          ```
          [COUNTRY]-[SUBJ]-[GRADE]-[TOPIC]-[NNN]-bundle.md
          ```

          Example: `MX-MAT-11-angulos-001-bundle.md`

          ## Required Frontmatter

          ```yaml
          ---
          id: "[COUNTRY]-[SUBJ]-[GRADE]-[TOPIC]-[NNN]"
          country: "[code]"
          grado: [number]
          asignatura: "[Subject in local language]"
          tema: "[Specific topic]"
          protocol_version: "2.0"
          total_questions: 7
          estado: "draft"
          creador: "Copilot"
          generation_date: "$(date +%Y-%m-%d)"
          source: "OpenTDB"
          source_url: "https://opentdb.com"
          source_license: "CC BY-SA 4.0"
          original_question: "[Original question in English]"
          original_answer: "[Original answer]"
          ---
          ```

          ## Pedagogical Explanation Requirements

          Each question MUST include:
          1. **Why the correct answer is correct** (detailed explanation)
          2. **Why each distractor is wrong** (common error analysis)
          3. **Competency evaluated** (linked to national curriculum)

          ## Quality Checklist

          Before completing, verify:
          - [ ] Exactly 7 questions per file
          - [ ] IDs use format: `[BASE-ID]-v[1-7]`
          - [ ] Difficulty progression: 1-2, 1-2, 3, 3, 4-5, 4-5
          - [ ] Cultural context in at least 4 of 7 questions
          - [ ] Distractors represent real student errors
          - [ ] Explanations are pedagogically detailed (50+ words)

          ## Reference

          See `docs/QUESTION_GENERATION_PROTOCOL_V2.md` for full specification.
          See `docs/examples/MX-MAT-11-angulos-001-bundle.md` for complete example.
          EOF

          echo "Prompt created successfully"

      - name: Comment on issue with instructions
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prompt = fs.readFileSync('/tmp/generation_prompt.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– Question Generation Started (Protocol v2.0)\n\n${prompt}\n\n---\n\n@copilot Please generate the question bundles following the Protocol v2.0 specification above.`
            });

      - name: Assign Copilot to issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: ['copilot']
              });
            } catch (error) {
              console.log('Could not assign Copilot:', error.message);
            }
