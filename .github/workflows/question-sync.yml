# =============================================================================
# World Exams - Workflow de Sincronizaci칩n de Preguntas
# =============================================================================
# Este workflow se ejecuta en el repo `question-sync` y procesa eventos
# de sincronizaci칩n entre repositorios de pa칤ses.
# =============================================================================

name: 游댃 Question Sync

on:
  # Webhook desde repos de pa칤ses
  repository_dispatch:
    types: [question_created, question_updated]

  # Trigger manual para sync completo
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Repo origen (ej: saber-co)'
        required: false
      target_repos:
        description: 'Repos destino (separados por coma)'
        required: false
      sync_all:
        description: 'Sincronizar todas las preguntas pendientes'
        type: boolean
        default: false

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  # =========================================================================
  # JOB: process_event
  # Procesa eventos de webhook (nueva pregunta creada)
  # =========================================================================
  process_event:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout question-sync
        uses: actions/checkout@v4

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 游닍 Install dependencies
        run: npm ci

      - name: 游닇 Log event info
        run: |
          echo "Event Type: ${{ github.event.action }}"
          echo "Source Repo: ${{ github.event.client_payload.source_repo }}"
          echo "Question ID: ${{ github.event.client_payload.question_id }}"

      - name: 游댃 Process question
        run: npm run process-question
        env:
          EVENT_TYPE: ${{ github.event.action }}
          PAYLOAD: ${{ toJson(github.event.client_payload) }}

      - name: 游깷 Translate question
        if: success()
        run: npm run translate-question
        env:
          QUESTION_ID: ${{ github.event.client_payload.question_id }}
          TARGET_LANGS: 'es-MX,es-AR,pt-BR,en-US'

      - name: 游니 Notify target repos
        if: success()
        run: npm run notify-repos
        env:
          QUESTION_ID: ${{ github.event.client_payload.question_id }}

  # =========================================================================
  # JOB: sync_pending
  # Sincroniza todas las preguntas pendientes (trigger manual)
  # =========================================================================
  sync_pending:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_all == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout
        uses: actions/checkout@v4

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 游닍 Install dependencies
        run: npm ci

      - name: 游댌 Get pending questions
        id: pending
        run: |
          result=$(npm run get-pending --silent)
          echo "pending_count=$result" >> $GITHUB_OUTPUT

      - name: 游댃 Sync all pending
        if: steps.pending.outputs.pending_count > 0
        run: npm run sync-all

      - name: 游늵 Report results
        run: npm run report-sync

  # =========================================================================
  # JOB: scheduled_sync
  # Sincronizaci칩n programada (diaria)
  # =========================================================================
  scheduled_sync:
    runs-on: ubuntu-latest
    # Ejecutar diariamente a las 6 AM UTC
    # schedule:
    #   - cron: '0 6 * * *'
    if: false  # Deshabilitado por ahora, habilitar cuando est칠 listo

    steps:
      - name: 游닌 Checkout
        uses: actions/checkout@v4

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 游닍 Install dependencies
        run: npm ci

      - name: 游댃 Daily sync
        run: npm run daily-sync

      - name: 游빛 Cleanup old events
        run: npm run cleanup-events
