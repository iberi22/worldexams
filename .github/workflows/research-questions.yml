# =============================================================================
# World Exams - Research & Generate Questions
# =============================================================================
# Workflow automatizado para:
# 1. Investigar preguntas de fuentes p√∫blicas (APIs, repos, datasets)
# 2. Crear issues con preguntas encontradas
# 3. Generar 6 variaciones de cada pregunta con Copilot
# Updated: 2024-12-04 - trigger refresh
# =============================================================================

name: üî¨ Research & Generate Questions

on:
  workflow_dispatch:
    inputs:
      country:
        description: 'Pa√≠s destino (c√≥digo)'
        required: true
        type: choice
        options:
          - CO
          - MX
          - BR
          - US
          - AR
          - CL
          - PE
          - ALL
      category:
        description: 'Categor√≠a de preguntas'
        required: true
        type: choice
        options:
          - science
          - mathematics
          - history
          - geography
          - general_knowledge
          - computers
      num_source_questions:
        description: 'Preguntas a investigar (se generan 6 variaciones c/u)'
        required: false
        type: number
        default: 5
      language:
        description: 'Idioma de salida'
        required: true
        type: choice
        options:
          - es
          - pt
          - en

  schedule:
    - cron: '0 6 * * 1'  # Lunes 6am UTC

# Permissions needed for creating issues and uploading artifacts
permissions:
  contents: read
  issues: write
  actions: read

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # =========================================================================
  # JOB 1: Investigar preguntas de fuentes p√∫blicas
  # =========================================================================
  research:
    runs-on: ubuntu-latest
    name: üìö Research from Public Sources
    outputs:
      questions_file: ${{ steps.fetch.outputs.questions_file }}
      num_questions: ${{ steps.fetch.outputs.num_questions }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies
        run: npm install node-fetch@3

      - name: üîç Fetch questions from Open Trivia DB
        id: fetch
        run: |
          CATEGORY="${{ inputs.category || 'science' }}"
          NUM="${{ inputs.num_source_questions || 5 }}"

          # Map category to OpenTDB ID
          case "$CATEGORY" in
            "science") CAT_ID=17 ;;
            "mathematics") CAT_ID=19 ;;
            "history") CAT_ID=23 ;;
            "geography") CAT_ID=22 ;;
            "general_knowledge") CAT_ID=9 ;;
            "computers") CAT_ID=18 ;;
            *) CAT_ID=9 ;;
          esac

          echo "üì° Fetching from OpenTDB (Category: $CATEGORY, ID: $CAT_ID)..."

          # Fetch from Open Trivia Database API
          curl -s "https://opentdb.com/api.php?amount=${NUM}&category=${CAT_ID}&type=multiple&encode=url3986" \
            -o /tmp/opentdb_raw.json

          # Process and save
          node << 'SCRIPT'
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('/tmp/opentdb_raw.json', 'utf8'));

          if (data.response_code !== 0) {
            console.error('API Error:', data);
            process.exit(1);
          }

          const questions = data.results.map((q, i) => ({
            id: i + 1,
            source: 'OpenTDB',
            source_url: 'https://opentdb.com',
            license: 'CC BY-SA 4.0',
            category: decodeURIComponent(q.category),
            difficulty: q.difficulty,
            question: decodeURIComponent(q.question),
            correct_answer: decodeURIComponent(q.correct_answer),
            incorrect_answers: q.incorrect_answers.map(a => decodeURIComponent(a)),
            original_language: 'en'
          }));

          fs.writeFileSync('/tmp/researched_questions.json', JSON.stringify(questions, null, 2));
          console.log(`‚úÖ Fetched ${questions.length} questions`);
          SCRIPT

          echo "questions_file=/tmp/researched_questions.json" >> $GITHUB_OUTPUT
          echo "num_questions=$(cat /tmp/researched_questions.json | node -e "console.log(JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')).length)")" >> $GITHUB_OUTPUT

      - name: üîç Fetch from GitHub repos (ICFES style)
        continue-on-error: true
        run: |
          echo "üì° Checking GitHub repos for curated questions..."

          # Intentar obtener preguntas del repo de matem√°ticas ICFES
          curl -s "https://api.github.com/repos/alvaretto/r-exams_matematicas/contents/Por%20Temas" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -o /tmp/github_repo.json || echo "Repo not accessible"

          echo "‚úÖ GitHub research complete"

      - name: üì§ Upload researched questions
        uses: actions/upload-artifact@v4
        with:
          name: researched-questions
          path: /tmp/researched_questions.json
          retention-days: 1

      - name: üìä Research Summary
        run: |
          echo "## üìö Research Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Questions Found |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| OpenTDB API | ${{ steps.fetch.outputs.num_questions }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sample Questions:" >> $GITHUB_STEP_SUMMARY
          cat /tmp/researched_questions.json | head -100 >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # JOB 2: Crear Issue para que Copilot genere variaciones
  # =========================================================================
  create-generation-issue:
    runs-on: ubuntu-latest
    name: üìù Create Generation Issue
    needs: research
    outputs:
      issue_number: ${{ steps.create_issue.outputs.issue_number }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì• Download researched questions
        uses: actions/download-artifact@v4
        with:
          name: researched-questions
          path: /tmp

      - name: üìù Create Issue for Copilot
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const questions = JSON.parse(fs.readFileSync('/tmp/researched_questions.json', 'utf8'));

            const country = '${{ inputs.country || "CO" }}';
            const language = '${{ inputs.language || "es" }}';
            const category = '${{ inputs.category || "science" }}';

            // Map country to folder and language
            const countryMap = {
              'CO': { folder: 'colombia', lang: 'es', exam: 'Saber 11' },
              'MX': { folder: 'mexico', lang: 'es', exam: 'EXANI-II' },
              'BR': { folder: 'brasil', lang: 'pt', exam: 'ENEM' },
              'US': { folder: 'usa', lang: 'en', exam: 'SAT' },
              'AR': { folder: 'argentina', lang: 'es', exam: 'UBA' },
              'CL': { folder: 'chile', lang: 'es', exam: 'PAES' },
              'PE': { folder: 'peru', lang: 'es', exam: 'Admisi√≥n' }
            };

            const config = countryMap[country] || countryMap['CO'];

            // Build issue body with instructions for Copilot
            let issueBody = `## üéØ Task: Generate Question Variations

            **Pa√≠s destino:** ${country} (${config.exam})
            **Idioma:** ${config.lang}
            **Categor√≠a:** ${category}
            **Carpeta destino:** \`src/content/questions/${config.folder}/\`

            ---

            ## üìã Instructions for Copilot

            For EACH source question below, generate **6 variations** following this format:

            \`\`\`markdown
            ---
            id: "${country}-[SUBJECT]-11-[TOPIC]-[XXX]"
            grado: 11
            asignatura: "[Subject in ${config.lang}]"
            tema: "[Topic]"
            dificultad: [1-5]
            estado: published
            creador: Copilot
            source: "[Original source name]"
            source_url: "[Original source URL]"
            source_license: "[License]"
            inspired_by: "[Original question summary]"
            variation: [1-6]
            ---

            # Pregunta
            [Question text in ${config.lang}]

            # Opciones
            - [ ] A) [Option A]
            - [ ] B) [Option B]
            - [x] C) [Correct answer]
            - [ ] D) [Option D]

            # Explicaci√≥n
            [Detailed explanation in ${config.lang}]
            \`\`\`

            ---

            ## üìö Source Questions to Expand

            `;

            // Add each question
            questions.forEach((q, i) => {
              issueBody += `
            ### Source ${i + 1}: ${q.category}

            - **Original:** ${q.question}
            - **Correct:** ${q.correct_answer}
            - **Wrong:** ${q.incorrect_answers.join(', ')}
            - **Source:** ${q.source} (${q.source_url})
            - **License:** ${q.license}
            - **Difficulty:** ${q.difficulty}

            **Generate 6 variations** of this question, adapting to ${config.exam} style and ${config.lang} language.

            ---
            `;
            });

            issueBody += `
            ## ‚úÖ Acceptance Criteria

            1. Each variation must be unique and test the same concept differently
            2. All text must be in **${config.lang}** language
            3. Include \`source\`, \`source_url\`, \`source_license\`, and \`inspired_by\` in frontmatter
            4. Create files in: \`src/content/questions/${config.folder}/[subject]/grado-11/\`
            5. Follow the ID format: \`${country}-[MAT|FIS|BIO|QUI|etc]-11-[topic]-[001-999]\`
            `;

            // Create the issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ Generate ${questions.length * 6} questions for ${country} - ${category}`,
              body: issueBody,
              labels: ['copilot', 'questions', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);

      - name: ü§ñ Assign Copilot to Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create_issue.outputs.issue_number }};

            try {
              // Try to assign Copilot to the issue
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: ['copilot']
              });
              console.log('‚úÖ Assigned Copilot to issue');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not assign Copilot directly:', error.message);

              // Add a comment to trigger Copilot
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '@github-copilot Please help generate the question variations described above.'
              });
              console.log('‚úÖ Added comment to trigger Copilot');
            }

      - name: üìä Summary
        run: |
          echo "## ‚úÖ Issue Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Issue #${{ steps.create_issue.outputs.issue_number }} created and assigned to Copilot" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View Issue](https://github.com/${{ github.repository }}/issues/${{ steps.create_issue.outputs.issue_number }})" >> $GITHUB_STEP_SUMMARY
