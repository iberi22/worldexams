name: Daily Question Generation

on:
  schedule:
    # Ejecutar diariamente a las 6:00 AM UTC (1:00 AM Colombia)
    - cron: '0 6 * * *'

  workflow_dispatch:
    inputs:
      countries:
        description: 'Countries to generate (comma-separated)'
        required: false
        default: 'CO,MX,BR,US'
        type: string
      categories:
        description: 'Categories to generate (comma-separated)'
        required: false
        default: 'mathematics,science,history,geography'
        type: string
      questions_per_batch:
        description: 'Source questions per batch'
        required: false
        default: '5'
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  DEFAULT_COUNTRIES: 'CO,MX,BR,US'
  DEFAULT_CATEGORIES: 'mathematics,science,history,geography'

jobs:
  generate-daily-plan:
    runs-on: ubuntu-latest
    name: Generate Daily Plan
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
      date: ${{ steps.plan.outputs.date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate execution plan
        id: plan
        run: |
          DATE=$(date +%Y-%m-%d)
          DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday

          echo "date=$DATE" >> $GITHUB_OUTPUT

          # Rotaci√≥n diaria de pa√≠ses y categor√≠as
          case $DAY_OF_WEEK in
            1) COUNTRY="CO"; CATEGORY="mathematics" ;;
            2) COUNTRY="MX"; CATEGORY="science" ;;
            3) COUNTRY="BR"; CATEGORY="history" ;;
            4) COUNTRY="US"; CATEGORY="geography" ;;
            5) COUNTRY="CO"; CATEGORY="computers" ;;
            6) COUNTRY="MX"; CATEGORY="general_knowledge" ;;
            7) COUNTRY="BR"; CATEGORY="mathematics" ;;
          esac

          # Si es manual, usar inputs
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            COUNTRIES="${{ inputs.countries }}"
            CATEGORIES="${{ inputs.categories }}"
          else
            COUNTRIES="$COUNTRY"
            CATEGORIES="$CATEGORY"
          fi

          echo "Selected: Countries=$COUNTRIES, Categories=$CATEGORIES"

          # Crear matriz para parallel jobs
          MATRIX=$(echo "{\"include\":[]}" | jq -c '.include = [
            {"country": "'$COUNTRY'", "category": "'$CATEGORY'", "lang": "es"}
          ]')

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  fetch-and-create-issue:
    runs-on: ubuntu-latest
    name: Fetch & Create Issue
    needs: generate-daily-plan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch questions from OpenTDB
        id: fetch
        run: |
          # Obtener d√≠a de la semana para rotaci√≥n
          DAY_OF_WEEK=$(date +%u)

          case $DAY_OF_WEEK in
            1) CATEGORY="mathematics"; CAT_ID=19; COUNTRY="CO"; LANG="es" ;;
            2) CATEGORY="science"; CAT_ID=17; COUNTRY="MX"; LANG="es" ;;
            3) CATEGORY="history"; CAT_ID=23; COUNTRY="BR"; LANG="pt" ;;
            4) CATEGORY="geography"; CAT_ID=22; COUNTRY="US"; LANG="en" ;;
            5) CATEGORY="computers"; CAT_ID=18; COUNTRY="CO"; LANG="es" ;;
            6) CATEGORY="general_knowledge"; CAT_ID=9; COUNTRY="MX"; LANG="es" ;;
            7) CATEGORY="mathematics"; CAT_ID=19; COUNTRY="BR"; LANG="pt" ;;
          esac

          NUM_QUESTIONS=5

          echo "Fetching $NUM_QUESTIONS questions for $COUNTRY - $CATEGORY (ID: $CAT_ID)"

          curl -s "https://opentdb.com/api.php?amount=${NUM_QUESTIONS}&category=${CAT_ID}&type=multiple&encode=url3986" \
            -o /tmp/opentdb_raw.json

          # Procesar respuesta
          node << 'SCRIPT'
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('/tmp/opentdb_raw.json', 'utf8'));

          if (data.response_code !== 0) {
            console.error('API Error:', data);
            process.exit(1);
          }

          const questions = data.results.map((q, i) => ({
            id: i + 1,
            source: 'OpenTDB',
            source_url: 'https://opentdb.com',
            license: 'CC BY-SA 4.0',
            category: decodeURIComponent(q.category),
            difficulty: q.difficulty,
            question: decodeURIComponent(q.question),
            correct_answer: decodeURIComponent(q.correct_answer),
            incorrect_answers: q.incorrect_answers.map(a => decodeURIComponent(a)),
            original_language: 'en'
          }));

          fs.writeFileSync('/tmp/researched_questions.json', JSON.stringify(questions, null, 2));
          console.log('Fetched ' + questions.length + ' questions');
          SCRIPT

          echo "country=$COUNTRY" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "language=$LANG" >> $GITHUB_OUTPUT

      - name: Create Issue for Copilot Agent
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const questions = JSON.parse(fs.readFileSync('/tmp/researched_questions.json', 'utf8'));
            const country = '${{ steps.fetch.outputs.country }}';
            const language = '${{ steps.fetch.outputs.language }}';
            const category = '${{ steps.fetch.outputs.category }}';
            const date = new Date().toISOString().split('T')[0];

            const countryMap = {
              'CO': { folder: 'saberparatodos/src/content/questions', lang: 'es', exam: 'Saber 11', name: 'Colombia', currency: 'COP', cities: ['Bogot√°', 'Medell√≠n', 'Cali'] },
              'MX': { folder: 'exani-mx/src/content/questions', lang: 'es', exam: 'EXANI-II', name: 'M√©xico', currency: 'MXN', cities: ['CDMX', 'Guadalajara', 'Monterrey'] },
              'BR': { folder: 'enem-br/src/content/questions', lang: 'pt', exam: 'ENEM', name: 'Brasil', currency: 'BRL', cities: ['S√£o Paulo', 'Rio', 'Bras√≠lia'] },
              'US': { folder: 'sat-us/src/content/questions', lang: 'en', exam: 'SAT', name: 'USA', currency: 'USD', cities: ['New York', 'Los Angeles', 'Chicago'] }
            };

            const config = countryMap[country] || countryMap['CO'];
            // Protocol V2.0: 7 questions per bundle
            const questionsPerBundle = 7;
            const totalQuestions = questions.length * questionsPerBundle;

            // Crear cuerpo del issue con instrucciones Protocol V2.0
            let body = `## ü§ñ Task: Generate ${totalQuestions} Questions (Protocol V2.0)

> **Protocol Version:** 2.0 (7 questions per bundle)

### üìã Assignment Details
- **Country:** ${country} (${config.name}) - ${config.exam}
- **Language:** ${config.lang}
- **Category:** ${category}
- **Date:** ${date}
- **Target folder:** \`${config.folder}/${category}/grado-11/\`
- **File format:** \`${country}-[CAT]-11-[topic]-[NNN]-bundle.md\`

---

## üìö Protocol V2.0 Requirements

For EACH source question, create a **bundle file** with **7 questions**:
1. **Original** (Difficulty 3) - Base question adapted to local context
2. **Easy A** (Difficulty 1-2) - Simplified version
3. **Easy B** (Difficulty 1-2) - Different context
4. **Medium A** (Difficulty 3) - Practical application
5. **Medium B** (Difficulty 3) - Analysis/comparison
6. **Hard A** (Difficulty 4-5) - Multi-step problem
7. **Hard B** (Difficulty 4-5) - Complex reasoning

### Required in each question:
- **Competency evaluated** (e.g., Interpretation, Argumentation)
- **Component** (e.g., Geometry, Syntax)
- **Rich explanation** with distractor analysis

---

## üéØ Source Questions

`;

            questions.forEach((q, i) => {
              body += `### Source ${i + 1}: ${q.category} (${q.difficulty})\n\n`;
              body += `- **Original Question:** ${q.question}\n`;
              body += `- **Correct Answer:** ${q.correct_answer}\n`;
              body += `- **Incorrect Answers:** ${q.incorrect_answers.join(', ')}\n`;
              body += `- **Source:** ${q.source} (${q.source_url})\n`;
              body += `- **License:** ${q.license}\n\n`;
              body += `**Create 1 bundle file with 7 questions for this source.**\n\n---\n\n`;
            });

            body += `## ‚úÖ Acceptance Criteria (Protocol V2.0)\n\n`;
            body += `- [ ] ${questions.length} bundle files created (7 questions each = ${totalQuestions} total)\n`;
            body += `- [ ] File naming: \`${country}-[CAT]-11-[topic]-[NNN]-bundle.md\`\n`;
            body += `- [ ] All files in \`${config.folder}/${category}/grado-11/\`\n`;
            body += `- [ ] Questions in **${config.lang}** language\n`;
            body += `- [ ] Include \`protocol_version: "2.0"\` in frontmatter\n`;
            body += `- [ ] Rich explanations with competency and component\n`;
            body += `- [ ] Use ${config.name} context (${config.currency}, ${config.cities.join(', ')})\n`;

            // Crear el issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[V2.0] Generate ${questions.length} ${category} bundles for ${country} (${totalQuestions} questions)`,
              body: body
            });

            // Intentar agregar labels (no falla si no existen)
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.data.number,
                labels: ['copilot', 'questions', 'automated', country.toLowerCase()]
              });
            } catch (labelError) {
              console.log(`‚ö†Ô∏è Could not add labels: ${labelError.message}`);
            }

            console.log(`Created issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

      - name: Assign Copilot to Issue
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const issueNumber = parseInt('${{ steps.create_issue.outputs.issue_number }}');

            console.log(`ü§ñ Attempting to assign Copilot to issue #${issueNumber}`);

            // Usar la API de Copilot Coding Agent
            // Documentaci√≥n: https://docs.github.com/en/copilot/using-github-copilot/using-copilot-coding-agent-to-work-on-tasks
            try {
              // La API correcta para asignar Copilot Coding Agent
              const response = await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: ['Copilot']
              });
              console.log('‚úÖ Copilot assigned successfully!');
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not assign Copilot: ${error.message}`);
              console.log('‚ÑπÔ∏è Note: Copilot Coding Agent must be enabled for this repository.');
              console.log('‚ÑπÔ∏è Manual assignment may be required via GitHub UI.');
            }

  notify-completion:
    runs-on: ubuntu-latest
    name: Notify Completion
    needs: [generate-daily-plan, fetch-and-create-issue]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## üìä Daily Question Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** ${{ needs.generate-daily-plan.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the created issue" >> $GITHUB_STEP_SUMMARY
          echo "2. Copilot will generate variations" >> $GITHUB_STEP_SUMMARY
          echo "3. Review and merge the PR" >> $GITHUB_STEP_SUMMARY
