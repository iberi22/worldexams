# =============================================================================
# World Exams - Workflow para Pull de Traducciones
# =============================================================================
# Este workflow se ejecuta en repos de paÃ­ses para obtener traducciones
# desde el sistema central de sincronizaciÃ³n.
# =============================================================================

name: ğŸ“¥ Pull Translations

on:
  # Webhook desde question-sync cuando hay traducciones disponibles
  repository_dispatch:
    types: [translations_ready]

  # Trigger manual
  workflow_dispatch:
    inputs:
      force_pull:
        description: 'Forzar pull de todas las traducciones'
        type: boolean
        default: false

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  COUNTRY_CODE: ${{ vars.COUNTRY_CODE }}

jobs:
  pull_translations:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Get available translations
        id: translations
        run: |
          # Query Supabase para traducciones pendientes para este paÃ­s
          count=$(npm run get-translations-count --silent)
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ Download translations
        if: steps.translations.outputs.count > 0
        run: |
          npm run download-translations

      - name: ğŸ“ Create question files
        if: steps.translations.outputs.count > 0
        run: |
          npm run create-question-files

      - name: âœ… Validate new questions
        if: steps.translations.outputs.count > 0
        run: |
          npm run validate

      - name: ğŸ“¤ Commit and push
        if: steps.translations.outputs.count > 0
        run: |
          git config user.name "World Exams Bot"
          git config user.email "bot@worldexams.org"

          git add src/content/questions/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“¥ Pull translations from question-sync"
            git push
          fi

      - name: ğŸ“Š Report
        run: |
          echo "âœ… Pull completed"
          echo "ğŸ“ Translations pulled: ${{ steps.translations.outputs.count }}"
